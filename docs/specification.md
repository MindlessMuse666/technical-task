# Спецификация автоматизации процесса обработки заявок на ремонт

## 1. BPMN-диаграмма процесса

BPMN-диаграмма, описывающая процесс обработки заявки на ремонт техники, представлена на **Рисунке 1**.

<div align="center"><img src="../docs/diagrams/BPMN-обработка-заявки-на-ремонт-техники.svg" alt="BPMN-обработка-заявки-на-ремонт-техники.svg"/></div>
<p align="center"><i>Рисунок 1. BPMN-диаграмма обработки заявки на ремонт техники</i></p>

## 2. ER-диаграмма данных

### 2.1. Представление ERD

ER-диаграмма, описывающая сущности системы, а также их атрибуты и связи, представлена на **Рисунке 2**.

<div align="center"><img src="../docs/diagrams/ERD-обработка-заявки-на-ремонт-техники.svg" alt="ERD-обработка-заявки-на-ремонт-техники.svg"/></div>
<p align="center"><i>Рисунок 2. ER-диаграмма: сущности, атрибуты и связи системы</i></p>

### 2.2. Описание сущностей и атрибутов (основа - PostgreSQL)

#### 2.2.1. Таблица `Client`

| Поле | Тип данных | Ограничения | Описание |
| ---- | ---------- | ----------- | -------- |
| **client_id** | SERIAL | PRIMARY KEY | Уникальный идентификатор клиента |
| **first_name** | VARCHAR | NOT NULL | Имя клиента |
| **last_name** | VARCHAR | NOT NULL | Фамилия клиента |
| **patronymic** | VARCHAR | NULL | Отчество клиента |
| **phone** | VARCHAR | NOT NULL, UNIQUE | Контактный телефон |
| **email** | VARCHAR | NULL, UNIQUE | Электронная почта |

#### 2.2.2. Таблица `Request` (заявка)

| Поле | Тип данных | Ограничения | Описание |
| ---- | ---------- | ----------- | -------- |
| **request_id** | SERIAL | PRIMARY KEY | Уникальный идентификатор заявки |
| **client_id** | INTEGER | NOT NULL, FOREIGN KEY (`Client`) | Ссылка на клиента |
| **manager_id** | INTEGER | NOT NULL, FOREIGN KEY (`Employee`) | Ссылка на менеджера |
| **engineer_id** | INTEGER | NULL, FOREIGN KEY (`Employee`) | Ссылка на инженера |
| **status_id** | INTEGER | NOT NULL, FOREIGN KEY (`Status`) | Текущий статус заявки |
| **problem_desc** | TEXT | NOT NULL | Описание проблемы |
| **device_model** | VARCHAR | NULL | Модель устройства |
| **created_at** | TIMESTAMP | NOT NULL, DEFAULT NOW() | Дата и время создания |
| **closed_at** | TIMESTAMP | NULL | Дата и время закрытия |

#### 2.2.3. Таблица `Employee` (менеджер/инженер)

| Поле | Тип данных | Ограничения | Описание |
| ---- | ---------- | ----------- | -------- |
| **employee_id** | SERIAL | PRIMARY KEY | Уникальный идентификатор сотрудника |
| **first_name** | VARCHAR | NOT NULL | Имя сотрудника |
| **last_name** | VARCHAR | NOT NULL | Фамилия сотрудника |
| **patronymic** | VARCHAR | NULL | Отчество сотрудника |
| **email** | VARCHAR | NULL, UNIQUE | Электронная почта |
| **role** | VARCHAR | NOT NULL | Роль: `manager` или `engineer` |
| **is_active** | BOOLEAN | NOT NULL, DEFAULT TRUE | Флаг активности (для распределения задач) |

#### 2.2.4. Таблица `Status`

| Поле | Тип данных | Ограничения | Описание |
| ---- | ---------- | ----------- | -------- |
| **status_id** | SERIAL | PRIMARY KEY | Уникальный идентификатор статуса |
| **status_name** | VARCHAR | NOT NULL, UNIQUE | Название статуса (`Новая`, `В работе` и прочие) |

#### 2.2.5. Таблица `Task`

| Поле | Тип данных | Ограничения | Описание |
| ---- | ---------- | ----------- | -------- |
| **task_id** | SERIAL | PRIMARY KEY | Уникальный идентификатор задачи |
| **request_id** | INTEGER | NOT NULL, FOREIGN KEY (`Request`) | Ссылка на заявку |
| **description** | TEXT | NOT NULL | Описание задачи |
| **is_complete** | BOOLEAN | NOT NULL, DEFAULT FALSE | Флаг выполнения |
| **created_at** | TIMESTAMP | NOT NULL, DEFAULT NOW() | Дата и время создания |

---

## 3. Функциональные требования (FR)

### 3.1. Модуль управления заявками

| ID | Требование | Приоритет |
| -- | ---------- | --------- |
| **FR-001** | Система должна предоставлять веб-форму для создания заявки клиентом. Форма должна содержать обязательные поля: `ФИО`, `телефон`, `описание проблемы`, и опциональные: `email`, `модель устройства`. | MUST HAVE |
| **FR-002** | Система должна автоматически создавать лид/сделку в CRM Битрикс24 с данными из веб-формы и присваивать ему статус `"Новая"`. | MUST HAVE |
| **FR-003** | Система должна предоставлять UI (карточку элемента CRM) для просмотра и редактирования всех данных по заявке для менеджеров. | MUST HAVE |
| **FR-004** | В карточке заявки должна вестись лента комментариев и история активностей: звонков, задач, изменений статусов. | SHOULD HAVE |

### 3.2. Модуль назначения и управления задачами

| ID | Требование | Приоритет |
| -- | ---------- | --------- |
| **FR-005** | Система должна автоматически назначать ответственного менеджера для новой заявки. | MUST HAVE |
| **FR-006** | Система должна предоставлять возможность менеджеру вручную создавать и назначать задачи инженерам в рамках заявки. Задача должна содержать: `название`, `описание`, `срок исполнения`, `ответственного инженера`. | MUST HAVE |
| **FR-007** | Система должна предоставлять UI (список задач) для инженера для просмотра назначенных ему задач, их выполнения и внесения комментариев о выполненной работе. | MUST HAVE |
| **FR-008** | Система должна предоставлять UI для ручного переназначения заявки другому менеджеру. | COULD HAVE |
| **FR-009** | Система должна позволять менеджеру создавать задачи на заказ запчастей, с указанием наименований, артикулов и количества. | COULD HAVE |

### 3.3. Модуль управления рабочими потоками и статусами

| ID | Требование | Приоритет |
| -- | ---------- | --------- |
| **FR-010** | Система должна предоставлять настраиваемый список статусов заявки по умолчанию: `"Новая"`, `"В работе"`, `"Ожидание запчастей"`, `"Завершена"`, `"Отменена"`. | MUST HAVE |
| **FR-011** | Система должна автоматически менять статус заявки на `"В работе"` при создании и назначении первой задачи инженеру. | MUST HAVE |
| **FR-012** | Система должна автоматически менять статус заявки на `"Ожидание запчастей"` при создании менеджером соответствующей задачи. | SHOULD HAVE |
| **FR-013** | Система должна автоматически менять статус заявки на `"Завершена"` после выполнения всех задач по заявке и ручного подтверждения менеджером. | MUST HAVE |
| **FR-014** | Система должна вести полную историю изменения статусов и ответственных для каждой заявки. | SHOULD HAVE |

### 3.4. Модуль уведомлений и коммуникаций

| ID | Требование | Приоритет |
| -- | ---------- | --------- |
| **FR-015** | Система должна автоматически отправлять уведомление (внутри Битрикс24 и/или email) менеджеру о назначении ему новой заявки. | MUST HAVE |
| **FR-016** | Система должна автоматически отправлять уведомление (внутри Битрикс24 и/или email) инженеру о назначении ему новой задачи. | MUST HAVE |
| **FR-017** | Система должна автоматически отправлять email- и/или SMS-уведомление клиенту с просьбой оставить отзыв при смене статуса заявки на `"Завершена"`. | SHOULD HAVE |
| **FR-018** | Система должна предоставлять возможность настраивать шаблоны уведомлений (email, SMS) для разных событий. | COULD HAVE |

### 3.5. Модуль отчетности и аналитики

| ID | Требование | Приоритет |
| -- | ---------- | --------- |
| **FR-019** | Система должна предоставлять отчеты по количеству заявок за период, по среднему времени выполнения, по загрузке инженеров. | SHOULD HAVE |
| **FR-020** | Система должна предоставлять дашборд для менеджера с отображением ключевых метрик: `открытые заявки`, `просроченные задачи`, `рейтинг инженеров`. | COULD HAVE |

---

## 4. Реализация процесса в Битрикс24

Таблица реализации автоматизации бизнес-процесса в Битрикс24:

| Шаг процесса | Инструмент | Как делаем в Битрикс24 |
| ------------ | ---------- | ---------------------- |
| 1. Создать структуру для заявок | Смарт-процесс | Создаем в CRM новый тип элемента `Ремонт` с полями: `Клиент`, `Описание проблемы`, `Менеджер`, `Инженер`, `Статус`. |
| 2. Назначить менеджера на новую заявку | Робот | Настраиваем правило: _"При создании элемента `Ремонт` -> автоматически назначить ответственного менеджера"_. |
| 3. Уведомить менеджера | Робот | Настраиваем правило: _"При смене ответственного в элементе `Ремонт` -> отправить этому человеку уведомление в чат Битрикс24"_. |
| 4. Создать задачу для инженера | Робот | Настраиваем правило: _"Когда в заявке `Ремонт` выбирается инженер -> создать для этого инженера задачу с описанием из заявки"_. |
| 5. Автоматически менять статусы | Робот | Настраиваем правила: _"При создании задачи инженеру -> менять статус заявки на `В работе`"_, _"При завершении всех задач -> менять статус на `Ждет контроля`"_. |
| 6. Обработать сложный сценарий (нет запчастей) | Бизнес-процесс | Создаем процесс с вопросом: _"Запчасти в наличии?". Ответ "Да" -> создаем задачу инженеру. Ответ "Нет" -> создаем задачу менеджеру "Заказать запчасти" и ставим заявку на паузу_. |
| 7. Запросить отзыв | Робот | Настраиваем правило: _"При смене статуса заявки на `Завершена` -> отправить клиенту письмо с ссылкой на форму отзыва"_. |
